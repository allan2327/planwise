machine:
  services:
    - docker

dependencies:
  cache_directories:
    - "~/sassc"
    - "~/libsass"
  post:
    - if [[ ! -e ~/sassc ]]; then git clone -b 3.3.6 git@github.com:sass/sassc.git ~/sassc; fi
    - if [[ ! -e ~/libsass ]]; then git clone --recursive -b 3.3.6 git@github.com:sass/libsass.git ~/libsass && cd ~/sassc && export SASS_LIBSASS_PATH=$(readlink -f ../libsass) && make && cd ..; fi
    - ln -s ~/sassc/bin/sassc ~/bin/sassc

test:
  override:
    - lein test

deployment:
  docker-main:
    branch:
      - master
      - stable
      - docker
    owner: instedd
    commands:
      - lein uberjar
      - docker login -e ${DOCKER_EMAIL} -u ${DOCKER_USER} -p ${DOCKER_PASS} ${DOCKER_REGISTRY}
      - docker/push . planwise ${DOCKER_REPOSITORY}:${CIRCLE_BRANCH/#master/latest}
  docker-tag:
    tag: /[0-9]+(\.[0-9]+)*(-pre\d+)?/
    owner: instedd
    commands:
      - lein uberjar
      - docker login -e ${DOCKER_EMAIL} -u ${DOCKER_USER} -p ${DOCKER_PASS} ${DOCKER_REGISTRY}
      - docker/push . planwise ${DOCKER_REPOSITORY}:${CIRCLE_TAG}
