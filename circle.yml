machine:
  services:
    - docker
    - postgresql
  java:
    version: oraclejdk8

dependencies:
  pre:
    - sudo add-apt-repository -y ppa:georepublic/pgrouting
    - sudo apt-get update
    - sudo apt-get -y install postgresql-9.5-pgrouting
  cache_directories:
    - "~/sassc"
    - "~/libsass"
  post:
    - if [[ ! -e ~/sassc ]]; then git clone -b 3.3.6 git@github.com:sass/sassc.git ~/sassc; fi
    - if [[ ! -e ~/libsass ]]; then git clone --recursive -b 3.3.6 git@github.com:sass/libsass.git ~/libsass && cd ~/sassc && export SASS_LIBSASS_PATH=$(readlink -f ../libsass) && make && cd ..; fi
    - ln -s ~/sassc/bin/sassc ~/bin/sassc

test:
  override:
    - createdb test
    - TEST_DATABASE_URL=jdbc:postgresql://localhost/test lein test

deployment:
  docker-main:
    branch:
      - master
      - stable
      - docker
    owner: instedd
    commands:
      - git describe --always > resources/planwise/version
      - lein uberjar
      - docker login -e ${DOCKER_EMAIL} -u ${DOCKER_USER} -p ${DOCKER_PASS} ${DOCKER_REGISTRY}
      - docker/push . planwise ${DOCKER_REPOSITORY}:${CIRCLE_BRANCH/#master/latest}
  docker-tag:
    tag: /[0-9]+(\.[0-9]+)*(-pre\d+)?/
    owner: instedd
    commands:
      - git describe --always > resources/planwise/version
      - lein uberjar
      - docker login -e ${DOCKER_EMAIL} -u ${DOCKER_USER} -p ${DOCKER_PASS} ${DOCKER_REGISTRY}
      - docker/push . planwise ${DOCKER_REPOSITORY}:${CIRCLE_TAG}
