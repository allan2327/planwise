version: '2'

services:
  db:
    image: starefossen/pgrouting:9.4-2.1-2.1
    environment:
      POSTGRES_PASSWORD: planwise
      POSTGRES_USER: planwise
      POSTGRES_DB: routing

  web:
    image: instedd/planwise:latest
    links:
      - startup
    ports:
      - "8080:8080"
    environment: &env
      DEMO_TILE_URL: "http://mapcache/mapcache/gmaps/kenya@GoogleMapsCompatible/{z}/{x}/{y}.png"
      JAR_PATH: /app/lib/planwise-0.5.0-SNAPSHOT-standalone.jar
      DATABASE_URL: "jdbc:postgresql://db/routing?user=planwise&password=planwise"
      POSTGRES_PASSWORD: planwise
      POSTGRES_USER: planwise
      POSTGRES_DB: routing
      POSTGRES_HOST: db
      PORT: 8080

  startup:
    image: instedd/planwise:latest
    command: /bin/sh -c "cd /app/scripts && ./import-osm && cd /app && ./scripts/migrate && ./scripts/load-regions"
    environment:
      <<: *env

  mapcache:
    image: instedd/planwise-mapserver:kenya-mapcache
    pid: host

  mapserver:
    image: instedd/planwise-mapserver:kenya-mapserver
    pid: host
    volumes_from:
      - mapserver-data

  mapserver-data:
    image: instedd/planwise-mapserver:kenya-data
    command: /bin/true
