#!/bin/bash
set -euo pipefail
export PGPASSWORD=$POSTGRES_PASSWORD;

OSM2PGROUTING=${1:-osm2pgrouting}

echo "Downloading Kenya OSM data and importing via osm2pgrouting"
curl -XGET https://s3.amazonaws.com/planwise/data/kenya-20160627.osm.gz | gunzip > /tmp/kenya.osm
${OSM2PGROUTING} -f /tmp/kenya.osm -c $(dirname "${BASH_SOURCE}")/mapconfig.xml -d $POSTGRES_DB -U $POSTGRES_USER -h $POSTGRES_HOST

echo "Populating ways_nodes table"
psql -d $POSTGRES_DB -U $POSTGRES_USER -h $POSTGRES_HOST << SQL_SCRIPT
SELECT populate_ways_nodes();
SELECT apply_traffic_factor(1.5);
SQL_SCRIPT
