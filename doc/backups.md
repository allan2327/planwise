# Backups

Backups are run every midnight on the planwise.instedd.org environment, and saved in the `planwise` S3 bucket, folder `backups`, using the timestamp as the name. Backups are configured with the following stack service definition:

```
pgbackups3:
  image: 'schickling/postgres-backup-s3:latest'
  command: '/bin/sh -c "sleep 5 && sh /run.sh"'
  environment:
    - POSTGRES_DATABASE=routing
    - 'POSTGRES_EXTRA_OPTS=-T facilities_polygons -T facilities_polygons_regions -T osm_nodes -T osm_relations -T osm_way_classes -T osm_way_tags -T osm_way_types -T relations_ways -T spatial_ref_sys -T ways -T ways_nodes -T ways_vertices_pgr'
    - POSTGRES_HOST=db
    - POSTGRES_PASSWORD=****
    - POSTGRES_USER=planwise
    - S3_ACCESS_KEY_ID=****
    - S3_BUCKET=planwise
    - S3_PREFIX=backups
    - S3_REGION=us-east-1
    - S3_SECRET_ACCESS_KEY=****
    - SCHEDULE='@daily'
  links:
    - db
```

Note that the following tables are excluded from the backup:
```
facilities_polygons facilities_polygons_regions osm_nodes osm_relations osm_way_classes osm_way_tags osm_way_types relations_ways spatial_ref_sys ways ways_nodes ways_vertices_pgr
```

To restore the backup, download the file, decompress it, and load it into a new database, creating a `planwise` database role if needed. Make sure to include the user, host and db flags as needed.
```bash
gzip -d BACKUP.sql.gz
psql -d routing -c "CREATE USER planwise WITH SUPERUSER"
psql -d routing < BACKUP.sql
psql -d routing < scripts/backuprestore-tables.sql
```

The script `backuprestore-tables.sql` contains the schema of the tables that are excluded from the database backup. Note that it can be regenerated by running the following, making sure the object's owner is set to planwise.
```bash
pg_dump -d routing -s -t facilities_polygons -t facilities_polygons_regions -t ways_nodes > scripts/backuprestore-tables.sql
```

After the backup is restored, load routing and regions data:
```bash
scripts/import-osm
scripts/load-regions
```

Finally, preprocess all isochrones by running:
```bash
lein preprocess-facilities all
```

Note that the `all` command will cause the `processing_status` for all facilities to be cleared before preprocessing.
